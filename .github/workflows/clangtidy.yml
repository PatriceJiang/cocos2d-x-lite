name: Clang Tidy

# Run this workflow every time a new commit pushed to your repository
on: pull_request

jobs:
  # Set the job key. The key is displayed as the job name
  # when a job name is not provided
  super-lint:
    # Name the Job
    name: Lint code base
    # Set the type of machine to run on
    runs-on: windows-latest

    steps:
      # Checks out a copy of your repository on the ubuntu-latest machine
      - name: Checkout code
        uses: actions/checkout@v2
      - uses: jitterbit/get-changed-files@v1
        id: listchanged
        with:
          format: space-delimited
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Install CMake & Clang Tidy
        run: |
          choco install cmake
          choco install llvm
          refreshenv

      - name: Generate Compile database
        run: |
          rm external/config.json
          git clone --branch v3d-gfx-30 --depth 1 https://github.com/cocos-creator/engine-native-external external
          cmake -Bbuild -G"Unix Makefiles" -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
      - name: Generate clang-fix.yaml
        run: clang-tidy -p build --export-fixes=clang-fixes.yaml ${{ steps.listchanged.outputs.added_modified }}
      - name: clang-tidy-action
        uses: asarium/clang-tidy-action@v1.0
        with:
          fixesFile: clang-fixes.yaml
